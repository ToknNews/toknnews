#!/usr/bin/env python3
"""
ToknNews Broadcast Loop (v1)

This is the unified orchestrator:
- Runs ingestion + compiler
- Hands results to ProgrammingDirector
- Dispatches segments to Script Engine v3
- Emits completed broadcast blocks to /data/broadcast/
"""
import sys
import os

# Add backend folder to module path
BACKEND_DIR = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
if BACKEND_DIR not in sys.path:
    sys.path.insert(0, BACKEND_DIR)

import os
import json
import time
from datetime import datetime

from script_engine.script_engine_v3 import generate_script
from script_engine.director.director_brain import ProgrammingDirector

# Paths
BASE = "/var/www/toknnews-live"
DATA = f"{BASE}/data"
LIVE_BACKEND = f"{BASE}/backend/live"

os.makedirs(f"{DATA}/broadcast", exist_ok=True)

# Instantiate Programming Director
PD = ProgrammingDirector()

def write_broadcast_block(block):
    """
    Saves each generated broadcast block as an atomic JSON file.
    """
    ts = datetime.utcnow().strftime("%Y%m%d_%H%M%S_%f")
    out_path = f"{DATA}/broadcast/block_{ts}.json"

    with open(out_path, "w") as f:
        json.dump(block, f, indent=2)

    print(f"[Broadcast] ✔ Wrote block → {out_path}")


def cycle_once():
    """
    Runs a full ingest → compile → PD segment → script engine cycle.
    """

    print("\n===== NEW BROADCAST CYCLE =====")

    # 1. INGESTION
    #os.system(f"python3 {LIVE_BACKEND}/hybrid_ingestor.py")

    # 2. COMPILE SCENES
    #os.system(f"python3 {LIVE_BACKEND}/scene_compiler_live.py")

    # 3. LOAD latest scene
    latest_path = f"{DATA}/latest_scene.json"
    if not os.path.exists(latest_path):
        print("[Broadcast] ⚠ No latest_scene.json found.")
        return

    with open(latest_path, "r") as f:
        latest = json.load(f)

    # 4. PD DECIDES WHAT SEGMENT TO RUN
    seg = PD.evaluate(
        story_queue=[latest],
        last_segment_result=PD.state.last_segment
    )

    print(f"[Director] → Selected segment: {seg}")

    # --- RESET HANDLER (PD-triggered chip_reset) ---
    if seg == "chip_reset":
        print("[Broadcast] → RESET EVENT TRIGGERED — Executing Chip Reset Sequence")

        script = generate_script({
            "type": "chip_reset",
            "stories": [latest]
        })

        write_broadcast_block(script)
        PD.state.last_segment = "chip_reset"
        return

    # 5. Script Engine block — PD payload normalization

    # NEWS (default path)
    if seg == "news":
        payload = latest

    # HIJINX (vega_pad)
    elif seg == "vega_pad":
        payload = {
            "type": "vega_pad",
            "hijinx_line": PD.state.hijinx_line
        }

    # BITSY META INTERRUPTION
    elif seg == "bitsy_meta":
        payload = {
            "type": "bitsy_meta",
            "line": PD.state.hijinx_line   # PD stores bitsy_line in hijinx handler
        }

    # EXPOSÉ / PANEL / BANTER OR ANY OTHER SEGMENT
    else:
        payload = {
            "type": seg,
            **latest
        }

    # 5B. Generate script for NON-reset segments
    script = generate_script(payload)

    # Ensure consistent structure
    block = script if "script_sequence" in script else {"script_sequence": script}

    # 6. Save broadcast block
    write_broadcast_block(block)
    PD.state.last_segment = seg

def main_loop():
    """
    Infinite broadcast loop.
    Adjust timing as needed.
    """
    while True:
        try:
            cycle_once()
        except Exception as e:
            print(f"[Broadcast] ❌ Error: {e}")
        time.sleep(10)   # adjust run frequency later


if __name__ == "__main__":
    main_loop()
